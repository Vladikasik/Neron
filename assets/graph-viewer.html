<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>Neo4j Graph Visualization</title>
  <style>
    body { 
      margin: 0; 
      padding: 0; 
      background: #000003;
      overflow: hidden;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    }
    #graph { 
      width: 100vw; 
      height: 100vh; 
    }

    /* Top-right console styling */
    #console {
      position: fixed;
      top: 10px;
      right: 10px;
      width: 350px;
      height: 300px;
      background: rgba(0, 0, 0, 0.9);
      border: 1px solid #00FF41;
      border-radius: 5px;
      padding: 10px;
      font-family: 'Courier New', monospace;
      font-size: 11px;
      color: #00FF41;
      box-shadow: 0 0 20px rgba(0, 255, 65, 0.3);
      backdrop-filter: blur(5px);
      z-index: 1000;
      display: flex;
      flex-direction: column;
    }

    #console-header {
      color: #00FF41;
      border-bottom: 1px solid #00FF41;
      padding-bottom: 5px;
      margin-bottom: 10px;
      font-weight: bold;
      text-transform: uppercase;
    }

    #log-display {
      flex: 1;
      overflow-y: auto;
      font-size: 10px;
      line-height: 1.2;
      padding-right: 5px;
    }

    #log-display::-webkit-scrollbar {
      width: 4px;
    }

    #log-display::-webkit-scrollbar-track {
      background: rgba(0, 255, 65, 0.1);
    }

    #log-display::-webkit-scrollbar-thumb {
      background: #00FF41;
      border-radius: 2px;
    }

    .log-entry {
      margin-bottom: 2px;
      opacity: 0.9;
    }

    .log-timestamp {
      color: #00BB29;
      font-size: 9px;
    }

    #input-area {
      margin-top: 10px;
      display: flex;
      align-items: center;
      border-top: 1px solid #00FF41;
      padding-top: 8px;
    }

    #input-prompt {
      color: #00FF41;
      margin-right: 5px;
      font-weight: bold;
    }

    #command-input {
      flex: 1;
      background: transparent;
      border: none;
      color: #00FF41;
      font-family: 'Courier New', monospace;
      font-size: 11px;
      outline: none;
    }

    #command-input::placeholder {
      color: rgba(0, 255, 65, 0.5);
    }

    /* Theme-aware console styling for regular theme */
    .regular-theme #console {
      background: rgba(255, 255, 255, 0.95);
      border-color: #2563eb;
      color: #1e40af;
      box-shadow: 0 0 20px rgba(37, 99, 235, 0.3);
    }

    .regular-theme #console-header {
      color: #1e40af;
      border-bottom-color: #2563eb;
    }

    .regular-theme .log-entry {
      color: #374151;
    }

    .regular-theme .log-timestamp {
      color: #6b7280;
    }

    .regular-theme #input-prompt {
      color: #1e40af;
    }

    .regular-theme #command-input {
      color: #1e40af;
    }

    .regular-theme #command-input::placeholder {
      color: rgba(30, 64, 175, 0.5);
    }

    .regular-theme #log-display::-webkit-scrollbar-track {
      background: rgba(37, 99, 235, 0.1);
    }

    .regular-theme #log-display::-webkit-scrollbar-thumb {
      background: #2563eb;
    }
  </style>
</head>
<body>
  <div id="graph"></div>
  
  <!-- Top-right console -->
  <div id="console">
    <div id="console-header">‚ö° NERON CONSOLE</div>
    <div id="log-display"></div>
    <div id="input-area">
      <span id="input-prompt">></span>
      <input type="text" id="command-input" placeholder="Type 'init' to load graph, 'SHUTDOWN' to clear..." />
    </div>
  </div>

  <script>
    // Global state
    let currentTheme = 'matrix';
    let currentGraph = null;
    let isGraphLoaded = false;

    // Console logging system
    function addLog(message, type = 'info') {
      const logDisplay = document.getElementById('log-display');
      const timestamp = new Date().toLocaleTimeString();
      const logEntry = document.createElement('div');
      logEntry.className = 'log-entry';
      logEntry.innerHTML = `<span class="log-timestamp">[${timestamp}]</span> ${message}`;
      logDisplay.appendChild(logEntry);
      logDisplay.scrollTop = logDisplay.scrollHeight;
      
      // Keep max 100 entries
      while (logDisplay.children.length > 100) {
        logDisplay.removeChild(logDisplay.firstChild);
      }
    }

    // Initial log
    addLog('üöÄ Neron Graph Engine initialized');
    addLog('üí° Commands: "init" to load graph, "SHUTDOWN" to clear');

    // Error handling
    window.addEventListener('error', function(e) {
      addLog(`‚ùå Error: ${e.message}`, 'error');
    });

    // Theme management
    function applyTheme(theme) {
      currentTheme = theme;
      const body = document.body;
      const prompt = document.getElementById('input-prompt');
      
      if (theme === 'regular') {
        body.classList.add('regular-theme');
        prompt.textContent = '$';
        addLog(`üé® Theme switched to REGULAR`);
      } else {
        body.classList.remove('regular-theme');
        prompt.textContent = '>';
        addLog(`üé® Theme switched to MATRIX`);
      }
      
      // Update graph colors if loaded
      if (isGraphLoaded && currentGraph) {
        updateGraphTheme(theme);
      }
    }

    function updateGraphTheme(theme) {
      if (!currentGraph) return;
      
      const nodeColors = theme === 'matrix' 
        ? ['#00FF41', '#00DD35', '#00BB29', '#00991D', '#007711']
        : ['#ef4444', '#f97316', '#eab308', '#22c55e', '#3b82f6', '#8b5cf6', '#ec4899'];
      
      const linkColor = theme === 'matrix' ? '#004d1a' : '#64748b';
      
      addLog(`üé® Updating graph colors for ${theme.toUpperCase()} theme`);
      
      // Note: Graph color updates would be applied here
      // This is handled by the theme context in the main app
    }

    // Command handling
    function handleCommand(command) {
      const cmd = command.trim().toLowerCase();
      addLog(`> ${command}`);
      
      if (cmd === 'init') {
        if (isGraphLoaded) {
          addLog('‚ö†Ô∏è Graph already loaded. Use "SHUTDOWN" first to clear.');
          return;
        }
        loadGraph();
      } else if (cmd === 'shutdown') {
        if (!isGraphLoaded) {
          addLog('‚ö†Ô∏è No graph to shutdown.');
          return;
        }
        shutdownGraph();
      } else if (cmd === 'help') {
        addLog('üìñ Available commands:');
        addLog('   ‚Ä¢ init - Load graph from test.json');
        addLog('   ‚Ä¢ SHUTDOWN - Clear current graph');
        addLog('   ‚Ä¢ help - Show this help');
      } else if (cmd === '') {
        // Do nothing for empty command
      } else {
        addLog(`‚ùì Unknown command: "${command}". Type "help" for available commands.`);
      }
    }

    function loadGraph() {
      addLog('üîÑ Loading graph data...');
      
      // Send message to React Native to get graph data
      if (window.ReactNativeWebView) {
        window.ReactNativeWebView.postMessage(JSON.stringify({
          type: 'request_graph_data'
        }));
      } else {
        addLog('‚ùå Cannot load graph: Not running in React Native WebView');
      }
    }

    function shutdownGraph() {
      addLog('üîÑ Shutting down graph...');
      
      // Clear the graph
      if (window.ReactNativeWebView) {
        window.ReactNativeWebView.postMessage(JSON.stringify({
          type: 'clear_graph'
        }));
      }
      
      currentGraph = null;
      isGraphLoaded = false;
      
      // Clear the graph display
      const graphElement = document.getElementById('graph');
      graphElement.innerHTML = '';
      
      addLog('‚úÖ Graph shutdown complete');
    }

    // Input handling
    document.getElementById('command-input').addEventListener('keypress', function(e) {
      if (e.key === 'Enter') {
        const command = this.value;
        if (command.trim()) {
          handleCommand(command);
          this.value = '';
        }
      }
    });

    // Message handling from React Native
    window.addEventListener('message', function(event) {
      try {
        const message = JSON.parse(event.data);
        
        if (message.type === 'updateTheme') {
          applyTheme(message.theme);
        } else if (message.type === 'loadGraphData') {
          displayGraph(message.data, message.theme);
        } else if (message.type === 'clearGraph') {
          shutdownGraph();
        }
      } catch (error) {
        addLog(`‚ùå Message parsing error: ${error.message}`);
      }
    });

    // Graph display function
    function displayGraph(data, theme) {
      addLog('üéØ Initializing 3D graph with Bloom effect...');
      
      try {
        // Import Three.js and react-force-graph-3d
        import('https://unpkg.com/react-force-graph-3d@1.25.4/dist/react-force-graph-3d.umd.js')
          .then(() => import('https://unpkg.com/three@0.157.0/build/three.module.js'))
          .then((THREE) => {
            return import('https://unpkg.com/three@0.157.0/examples/jsm/postprocessing/UnrealBloomPass.js');
          })
          .then((UnrealBloomModule) => {
            const UnrealBloomPass = UnrealBloomModule.UnrealBloomPass;
            
            // Clear previous graph
            const graphElement = document.getElementById('graph');
            graphElement.innerHTML = '';
            
            // Create graph
            const Graph = ForceGraph3D();
            
            // Apply theme colors
            const nodeColors = theme === 'matrix' 
              ? ['#00FF41', '#00DD35', '#00BB29', '#00991D', '#007711']
              : ['#ef4444', '#f97316', '#eab308', '#22c55e', '#3b82f6', '#8b5cf6', '#ec4899'];
            
            const linkColor = theme === 'matrix' ? '#004d1a' : '#64748b';
            const backgroundColor = theme === 'matrix' ? '#000003' : '#f8fafc';
            
            Graph(graphElement)
              .graphData(data)
              .backgroundColor(backgroundColor)
              .nodeAutoColorBy('type')
              .nodeColor(node => {
                const colorIndex = Math.abs(node.id.split('').reduce((a, b) => a + b.charCodeAt(0), 0)) % nodeColors.length;
                return nodeColors[colorIndex];
              })
              .linkColor(() => linkColor)
              .nodeLabel('name')
              .linkLabel(link => `${link.source} ‚Üí ${link.target}`)
              .onNodeClick(node => {
                if (window.ReactNativeWebView) {
                  window.ReactNativeWebView.postMessage(JSON.stringify({
                    type: 'nodeClicked',
                    node: node,
                    allData: data
                  }));
                }
              })
              .enableNodeDrag(true)
              .onEngineStop(() => {
                addLog('üéØ Graph layout stabilized');
                
                // Add Bloom Post-Processing Effect - EXACT OFFICIAL IMPLEMENTATION
                const bloomPass = new UnrealBloomPass();
                bloomPass.strength = 4;  // Exact values from Vasturiano example
                bloomPass.radius = 1;
                bloomPass.threshold = 0;
                
                try {
                  Graph.postProcessingComposer().addPass(bloomPass);
                  addLog('‚ú® Bloom effect applied successfully');
                } catch (bloomError) {
                  addLog(`‚ö†Ô∏è Bloom effect warning: ${bloomError.message}`);
                }
              });
            
            currentGraph = Graph;
            isGraphLoaded = true;
            
            addLog(`‚úÖ Graph loaded: ${data.entities.length} entities, ${data.relations.length} relations`);
            addLog('üéÆ Graph controls: drag to rotate, scroll to zoom, click nodes for details');
            
          })
          .catch(error => {
            addLog(`‚ùå Graph loading error: ${error.message}`);
            console.error('Graph loading error:', error);
          });
          
      } catch (error) {
        addLog(`‚ùå Graph initialization error: ${error.message}`);
        console.error('Graph initialization error:', error);
      }
    }

    // Apply initial Matrix theme
    applyTheme('matrix');
  </script>
</body>
</html> 