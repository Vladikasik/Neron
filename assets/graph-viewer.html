<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>Neo4j Graph Visualization</title>
  
  <!-- iOS-specific meta tags for better WebView compatibility -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="format-detection" content="telephone=no">
  
  <!-- Content Security Policy for iOS WebView compatibility -->
  <meta http-equiv="Content-Security-Policy" content="default-src 'self' 'unsafe-inline' 'unsafe-eval' data: blob: https:; script-src 'self' 'unsafe-inline' 'unsafe-eval' https://unpkg.com; style-src 'self' 'unsafe-inline';">
  
  <style>
    /* Base styling for the application */
    * {
      box-sizing: border-box;
    }

    body { 
      margin: 0; 
      padding: 0; 
      background: #000003;
      overflow: hidden;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      user-select: none;
      /* iOS-specific optimizations */
      -webkit-touch-callout: none;
      -webkit-user-select: none;
      -webkit-tap-highlight-color: transparent;
    }

    #graph-container {
      position: relative;
      width: 100vw; 
      height: 100vh;
    }

    #graph {
      width: 100%;
      height: 100%;
      /* iOS WebGL optimizations */
      -webkit-backface-visibility: hidden;
      -webkit-transform: translateZ(0);
      transform: translateZ(0);
    }

    /* Error display for iOS WebGL issues */
    #error-display {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(255, 0, 0, 0.1);
      border: 1px solid #ff0000;
      border-radius: 8px;
      padding: 20px;
      color: #ff0000;
      font-family: 'Courier New', monospace;
      text-align: center;
      z-index: 2000;
      display: none;
    }

    /* Loading indicator */
    #loading-indicator {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      color: #00FF41;
      font-family: 'Courier New', monospace;
      font-size: 16px;
      z-index: 2000;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .spinner {
      width: 20px;
      height: 20px;
      border: 2px solid #00FF41;
      border-radius: 50%;
      border-top-color: transparent;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Console toggle button in bottom-left */
    #console-toggle {
      position: fixed;
      bottom: 20px;
      left: 20px;
      width: 50px;
      height: 50px;
      background: rgba(0, 0, 0, 0.8);
      border: 2px solid #00FF41;
      border-radius: 50%;
      color: #00FF41;
      font-family: 'Courier New', monospace;
      font-size: 20px;
      font-weight: bold;
      cursor: pointer;
      z-index: 1001;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s ease;
      backdrop-filter: blur(5px);
    }

    #console-toggle:hover {
      background: rgba(0, 255, 65, 0.1);
      box-shadow: 0 0 20px rgba(0, 255, 65, 0.5);
      transform: scale(1.1);
    }

    #console-toggle:active {
      transform: scale(0.95);
    }

    /* Draggable console window styling */
    .console-window {
      position: fixed;
      top: 50px;
      right: 50px;
      width: 400px;
      height: 350px;
      background: rgba(0, 0, 0, 0.95);
      border: 2px solid #00FF41;
      border-radius: 8px;
      box-shadow: 0 0 30px rgba(0, 255, 65, 0.3);
      backdrop-filter: blur(10px);
      z-index: 1000;
      display: flex;
      flex-direction: column;
      font-family: 'Courier New', monospace;
      transition: all 0.3s ease;
      resize: both;
      overflow: hidden;
      min-width: 300px;
      min-height: 200px;
      max-width: 80vw;
      max-height: 80vh;
    }

    .console-window.hidden {
      transform: scale(0.8);
      opacity: 0;
      pointer-events: none;
    }

    .console-window.dragging {
      transition: none;
      box-shadow: 0 0 40px rgba(0, 255, 65, 0.5);
    }

    /* Console header */
    .console-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 15px;
      background: rgba(0, 255, 65, 0.1);
      border-bottom: 1px solid #00FF41;
      cursor: move;
      user-select: none;
      min-height: 40px;
    }

    .console-header:hover {
      background: rgba(0, 255, 65, 0.15);
    }

    .console-title {
      color: #00FF41;
      font-weight: bold;
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .console-controls {
      display: flex;
      gap: 5px;
    }

    .console-btn {
      width: 20px;
      height: 20px;
      background: rgba(0, 255, 65, 0.2);
      border: 1px solid #00FF41;
      border-radius: 3px;
      color: #00FF41;
      font-family: 'Courier New', monospace;
      font-size: 12px;
      font-weight: bold;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s ease;
    }

    .console-btn:hover {
      background: rgba(0, 255, 65, 0.3);
      transform: scale(1.1);
    }

    .console-btn:active {
      transform: scale(0.95);
    }

    /* Console content */
    .console-content {
      display: flex;
      flex-direction: column;
      flex: 1;
      overflow: hidden;
      padding: 10px;
    }

    .log-display {
      flex: 1;
      overflow-y: auto;
      font-size: 11px;
      line-height: 1.3;
      color: #00FF41;
      padding: 5px;
      background: rgba(0, 0, 0, 0.3);
      border: 1px solid rgba(0, 255, 65, 0.2);
      border-radius: 4px;
      margin-bottom: 10px;
    }

    .log-display::-webkit-scrollbar {
      width: 6px;
    }

    .log-display::-webkit-scrollbar-track {
      background: rgba(0, 255, 65, 0.1);
    }

    .log-display::-webkit-scrollbar-thumb {
      background: #00FF41;
      border-radius: 3px;
    }

    .log-entry {
      margin-bottom: 3px;
      opacity: 0.9;
      word-wrap: break-word;
      animation: fadeIn 0.3s ease;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 0.9; transform: translateY(0); }
    }

    .log-timestamp {
      color: #00BB29;
      font-size: 10px;
      margin-right: 5px;
    }

    .log-error {
      color: #FF6B6B;
    }

    .log-warning {
      color: #FFB347;
    }

    .log-success {
      color: #00DD35;
    }

    .log-info {
      color: #4ECDC4;
    }

    /* Input area */
    .input-area {
      display: flex;
      align-items: center;
      gap: 5px;
      padding: 8px;
      background: rgba(0, 0, 0, 0.3);
      border: 1px solid rgba(0, 255, 65, 0.2);
      border-radius: 4px;
    }

    .input-prompt {
      color: #00FF41;
      font-weight: bold;
      font-size: 12px;
      min-width: 15px;
    }

    .command-input {
      flex: 1;
      background: transparent;
      border: none;
      color: #00FF41;
      font-family: 'Courier New', monospace;
      font-size: 12px;
      outline: none;
      padding: 4px;
    }

    .command-input::placeholder {
      color: rgba(0, 255, 65, 0.4);
    }

    .command-input:focus {
      background: rgba(0, 255, 65, 0.05);
    }

    /* Regular theme */
    .regular-theme {
      background: #f8fafc;
      color: #1e293b;
    }

    .regular-theme body {
      background: #f8fafc;
    }

    .regular-theme #console-toggle {
      background: rgba(255, 255, 255, 0.9);
      border-color: #2563eb;
      color: #1e40af;
    }

    .regular-theme #console-toggle:hover {
      background: rgba(37, 99, 235, 0.1);
      box-shadow: 0 0 20px rgba(37, 99, 235, 0.5);
    }

    .regular-theme .console-window {
      background: rgba(255, 255, 255, 0.95);
      border-color: #2563eb;
      box-shadow: 0 0 30px rgba(37, 99, 235, 0.3);
      color: #1e40af;
    }

    .regular-theme .console-header {
      background: rgba(37, 99, 235, 0.1);
      border-bottom-color: #2563eb;
    }

    .regular-theme .console-title {
      color: #1e40af;
    }

    .regular-theme .console-btn {
      background: rgba(37, 99, 235, 0.2);
      border-color: #2563eb;
      color: #1e40af;
    }

    .regular-theme .console-btn:hover {
      background: rgba(37, 99, 235, 0.3);
    }

    .regular-theme .log-display {
      background: rgba(248, 250, 252, 0.5);
      border-color: rgba(37, 99, 235, 0.2);
      color: #374151;
    }

    .regular-theme .log-display::-webkit-scrollbar-track {
      background: rgba(37, 99, 235, 0.1);
    }

    .regular-theme .log-display::-webkit-scrollbar-thumb {
      background: #2563eb;
    }

    .regular-theme .log-timestamp {
      color: #6b7280;
    }

    .regular-theme .input-area {
      background: rgba(248, 250, 252, 0.5);
      border-color: rgba(37, 99, 235, 0.2);
    }

    .regular-theme .input-prompt {
      color: #1e40af;
    }

    .regular-theme .command-input {
      color: #1e40af;
    }

    .regular-theme .command-input::placeholder {
      color: rgba(30, 64, 175, 0.4);
    }

    .regular-theme .command-input:focus {
      background: rgba(37, 99, 235, 0.05);
    }

    /* Regular theme log levels */
    .regular-theme .log-error {
      color: #dc2626;
    }

    .regular-theme .log-warning {
      color: #d97706;
    }

    .regular-theme .log-success {
      color: #16a34a;
    }

    .regular-theme .log-info {
      color: #0284c7;
    }

    /* Scrollbar styling */
    ::-webkit-scrollbar {
      width: 6px;
    }

    ::-webkit-scrollbar-track {
      background: rgba(0, 255, 65, 0.1);
    }

    ::-webkit-scrollbar-thumb {
      background: #00FF41;
      border-radius: 3px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: #00DD35;
    }
  </style>

  <!-- Load libraries from CDN - this works on iOS WebView -->
  <script src="https://unpkg.com/three@0.157.0/build/three.min.js"></script>
  <script src="https://unpkg.com/3d-force-graph@1.77.0/dist/3d-force-graph.min.js"></script>
</head>
<body>
  <!-- Loading indicator -->
  <div id="loading-indicator">
    <div class="spinner"></div>
    <span>Loading Neural Matrix...</span>
  </div>

  <!-- Error display -->
  <div id="error-display">
    <h3>⚠️ Graphics Error</h3>
    <p id="error-message">Unable to initialize 3D graphics</p>
    <button onclick="retryGraphInitialization()">Retry</button>
  </div>

  <div id="graph-container">
    <div id="graph"></div>
  </div>
  
  <!-- Console toggle button (bottom-left) -->
  <button id="console-toggle" class="console-visible" title="Toggle Console">⚡</button>
  
  <!-- Draggable console window -->
  <div id="console-window" class="console-window">
    <div id="console-header" class="console-header">
      <span class="console-title">⚡ NERON CONSOLE v2.0</span>
      <div class="console-controls">
        <button id="console-close" class="console-btn">×</button>
      </div>
    </div>
    <div id="console-content" class="console-content">
      <div id="log-display" class="log-display"></div>
      <div id="input-area" class="input-area">
        <span id="input-prompt" class="input-prompt">></span>
        <input type="text" id="command-input" class="command-input" placeholder="Type 'help' for commands..." />
      </div>
    </div>
  </div>

  <script>
    // iOS WebGL context recovery and error handling
    let graphInstance = null;
    let isGraphInitialized = false;
    let retryCount = 0;
    const MAX_RETRIES = 3;

    // Initialize the application when DOM is ready
    document.addEventListener('DOMContentLoaded', function() {
      try {
        console.log('🔧 Initializing Neron Graph Engine v2.0...');
        console.log('🌐 Environment:', window.ReactNativeWebView ? 'React Native' : 'Web Browser');
        console.log('📱 Platform:', navigator.platform);
        console.log('🔧 User Agent:', navigator.userAgent);
        
        // Check if we're on iOS
        const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) || (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);
        console.log('🍎 iOS Detected:', isIOS);
        
        // Hide loading indicator initially
        hideLoadingIndicator();
        
        // Logger class - inline implementation
        class Logger {
          constructor() {
            this.levels = { ERROR: 0, WARN: 1, INFO: 2, DEBUG: 3 };
            this.currentLevel = this.levels.INFO;
            this.prefix = '[NeronEngine]';
            this.startTime = Date.now();
            this.sessionId = Math.random().toString(36).substring(2, 15);
            console.log(`${this.prefix} Logger initialized - Session: ${this.sessionId}`);
          }
          
          formatMessage(level, message, data = null) {
            const timestamp = new Date().toISOString();
            const uptime = Date.now() - this.startTime;
            const baseMessage = `${this.prefix} [${level}] [${timestamp}] [+${uptime}ms] ${message}`;
            return { baseMessage, data };
          }
          
          log(level, message, data = null) {
            if (this.levels[level] > this.currentLevel) return;
            
            const { baseMessage, data: logData } = this.formatMessage(level, message, data);
            
            switch (level) {
              case 'ERROR': console.error(baseMessage, logData || ''); break;
              case 'WARN': console.warn(baseMessage, logData || ''); break;
              case 'INFO': console.info(baseMessage, logData || ''); break;
              case 'DEBUG': console.debug(baseMessage, logData || ''); break;
              default: console.log(baseMessage, logData || '');
            }
            
            // Send to React Native if available
            if (window.ReactNativeWebView) {
              try {
                window.ReactNativeWebView.postMessage(JSON.stringify({
                  type: 'log', level: level.toLowerCase(), message: baseMessage, data: logData, sessionId: this.sessionId
                }));
              } catch (e) {
                console.error(`${this.prefix} Failed to send log to React Native:`, e);
              }
            }
          }
          
          error(message, data = null) { this.log('ERROR', message, data); }
          warn(message, data = null) { this.log('WARN', message, data); }
          info(message, data = null) { this.log('INFO', message, data); }
          debug(message, data = null) { this.log('DEBUG', message, data); }
          success(message, data = null) {
            const { baseMessage, data: logData } = this.formatMessage('SUCCESS', message, data);
            console.log(`%c${baseMessage}`, 'color: #00DD35', logData || '');
            if (window.ReactNativeWebView) {
              try {
                window.ReactNativeWebView.postMessage(JSON.stringify({
                  type: 'log', level: 'success', message: baseMessage, data: logData, sessionId: this.sessionId
                }));
              } catch (e) {
                console.error(`${this.prefix} Failed to send log to React Native:`, e);
              }
            }
          }
          
          setLevel(level) {
            if (this.levels[level] !== undefined) {
              this.currentLevel = this.levels[level];
              this.info(`Log level set to: ${level}`);
            } else {
              this.warn(`Invalid log level: ${level}`);
            }
          }
        }

        // Create global logger
        window.Logger = new Logger();

        // Initialize with retry mechanism
        initializeWithRetry();
        
      } catch (error) {
        console.error('❌ Failed to initialize Neron Graph Engine:', error);
        showError('Failed to initialize application: ' + error.message);
        
        // Notify React Native of initialization failure
        if (window.ReactNativeWebView) {
          try {
            window.ReactNativeWebView.postMessage(JSON.stringify({
              type: 'initialization_failed',
              error: error.message
            }));
          } catch (e) {
            console.error('Failed to send initialization failure to React Native:', e);
          }
        }
      }
    });

    // Retry mechanism for iOS WebGL issues
    function initializeWithRetry() {
      showLoadingIndicator();
      
      setTimeout(() => {
        try {
          // Simple NeronGraphEngine initialization
          window.Logger.info('🚀 Neron Graph Engine loading...');
          
          // Check libraries with detailed error reporting
          const libraryStatus = checkLibrariesWithDetails();
          
          if (!libraryStatus.allReady) {
            throw new Error(`Libraries not ready: ${libraryStatus.missing.join(', ')}`);
          }

          // Initialize console functionality
          initializeConsole();
          
          // Ensure console is visible
          showConsole();
          
          window.Logger.success('✅ Neron Graph Engine initialized successfully');
          
          // Add welcome message to console with timestamp to verify updates
          const buildTime = new Date().toISOString();
          addLogEntry('🚀 Neron Graph Engine v2.0 initialized', 'success');
          addLogEntry('💻 Console: Drag header to move, × to hide', 'info');
          addLogEntry(`🕒 Build: ${buildTime}`, 'info');
          addLogEntry('Type "help" for available commands', 'info');
          
          isGraphInitialized = true;
          hideLoadingIndicator();
          
          // Notify React Native of successful initialization
          if (window.ReactNativeWebView) {
            try {
              window.ReactNativeWebView.postMessage(JSON.stringify({
                type: 'initialization_complete'
              }));
            } catch (e) {
              console.error('Failed to send initialization success to React Native:', e);
            }
          }
          
        } catch (error) {
          console.error('❌ Initialization failed:', error);
          
          if (retryCount < MAX_RETRIES) {
            retryCount++;
            window.Logger.warn(`Retrying initialization (${retryCount}/${MAX_RETRIES})...`);
            setTimeout(() => initializeWithRetry(), 2000);
          } else {
            hideLoadingIndicator();
            showError('Failed to initialize after multiple attempts. This may be due to iOS WebGL limitations.');
            
            // Still show console for debugging
            try {
              initializeConsole();
              showConsole();
              addLogEntry('❌ Graphics initialization failed', 'error');
              addLogEntry('💡 Console available for debugging', 'info');
            } catch (consoleError) {
              console.error('Console initialization also failed:', consoleError);
            }
          }
        }
      }, 1000);
    }

    // Enhanced library checking with detailed error reporting
    function checkLibrariesWithDetails() {
      const checks = [
        { name: 'THREE.js', available: typeof window.THREE !== 'undefined', global: 'THREE' },
        { name: 'ForceGraph3D', available: typeof window.ForceGraph3D !== 'undefined', global: 'ForceGraph3D' }
      ];
      
      const missing = checks.filter(check => !check.available).map(check => check.name);
      const allReady = missing.length === 0;
      
      checks.forEach(check => {
        const status = check.available ? '✅' : '❌';
        window.Logger.info(`${status} ${check.name}: ${check.available ? 'Available' : 'Missing'}`);
        if (!check.available) {
          console.error(`${check.global} is not defined. Check if ${check.name} script loaded correctly.`);
        }
      });
      
      window.Logger.info(`📊 Libraries ready: ${allReady ? 'YES' : 'NO'}`);
      
      return { allReady, missing, available: checks.filter(check => check.available) };
    }

    // Loading indicator management
    function showLoadingIndicator() {
      const indicator = document.getElementById('loading-indicator');
      if (indicator) indicator.style.display = 'flex';
    }

    function hideLoadingIndicator() {
      const indicator = document.getElementById('loading-indicator');
      if (indicator) indicator.style.display = 'none';
    }

    // Error display management
    function showError(message) {
      const errorDiv = document.getElementById('error-display');
      const errorMessage = document.getElementById('error-message');
      if (errorDiv && errorMessage) {
        errorMessage.textContent = message;
        errorDiv.style.display = 'block';
      }
    }

    function hideError() {
      const errorDiv = document.getElementById('error-display');
      if (errorDiv) errorDiv.style.display = 'none';
    }

    // Retry function for manual retry
    function retryGraphInitialization() {
      hideError();
      retryCount = 0;
      isGraphInitialized = false;
      initializeWithRetry();
    }

    // Console functionality
    let isConsoleVisible = true;

    function initializeConsole() {
      // Console toggle functionality
      const toggleButton = document.getElementById('console-toggle');
      const consoleWindow = document.getElementById('console-window');
      
      if (toggleButton) {
        toggleButton.addEventListener('click', function(e) {
          e.stopPropagation();
          toggleConsole();
        });
      }

      // Console controls
      const closeBtn = document.getElementById('console-close');
      
      if (closeBtn) {
        closeBtn.addEventListener('click', function(e) {
          e.stopPropagation();
          hideConsole();
        });
      }

      // Setup drag functionality
      setupDragFunctionality();
      
      // Setup command input
      setupCommandInput();
      
      window.Logger.info('Console initialized successfully');
    }

    function toggleConsole() {
      if (isConsoleVisible) {
        hideConsole();
      } else {
        showConsole();
      }
    }

    function showConsole() {
      const consoleWindow = document.getElementById('console-window');
      const toggleButton = document.getElementById('console-toggle');
      
      isConsoleVisible = true;
      consoleWindow.classList.remove('hidden');
      toggleButton.innerHTML = '⚡';
      toggleButton.title = 'Hide Console';
      
      // Focus on input
      setTimeout(() => {
        const commandInput = document.getElementById('command-input');
        if (commandInput) commandInput.focus();
      }, 100);
    }

    function hideConsole() {
      const consoleWindow = document.getElementById('console-window');
      const toggleButton = document.getElementById('console-toggle');
      
      isConsoleVisible = false;
      consoleWindow.classList.add('hidden');
      toggleButton.innerHTML = '👁️';
      toggleButton.title = 'Show Console';
    }

    function setupDragFunctionality() {
      const consoleWindow = document.getElementById('console-window');
      const consoleHeader = document.getElementById('console-header');
      let isDragging = false;

      consoleHeader.addEventListener('mousedown', function(e) {
        if (e.target.classList.contains('console-btn')) return;
        
        isDragging = true;
        consoleWindow.classList.add('dragging');
        
        const startX = e.clientX;
        const startY = e.clientY;
        const rect = consoleWindow.getBoundingClientRect();
        const startLeft = rect.left;
        const startTop = rect.top;

        function handleMouseMove(e) {
          if (!isDragging) return;
          
          const deltaX = e.clientX - startX;
          const deltaY = e.clientY - startY;
          let newLeft = startLeft + deltaX;
          let newTop = startTop + deltaY;
          
          // Boundary constraints
          const windowWidth = window.innerWidth;
          const windowHeight = window.innerHeight;
          const consoleWidth = consoleWindow.offsetWidth;
          const consoleHeight = consoleWindow.offsetHeight;
          
          newLeft = Math.max(0, Math.min(windowWidth - consoleWidth, newLeft));
          newTop = Math.max(0, Math.min(windowHeight - consoleHeight, newTop));
          
          consoleWindow.style.left = `${newLeft}px`;
          consoleWindow.style.top = `${newTop}px`;
          consoleWindow.style.right = 'auto';
          consoleWindow.style.bottom = 'auto';
        }

        function handleMouseUp() {
          isDragging = false;
          consoleWindow.classList.remove('dragging');
          document.removeEventListener('mousemove', handleMouseMove);
          document.removeEventListener('mouseup', handleMouseUp);
        }

        document.addEventListener('mousemove', handleMouseMove);
        document.addEventListener('mouseup', handleMouseUp);
        e.preventDefault();
      });
    }

    function setupCommandInput() {
      const commandInput = document.getElementById('command-input');
      if (!commandInput) return;

      commandInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
          e.preventDefault();
          const command = this.value;
          if (command.trim()) {
            handleCommand(command);
            this.value = '';
          }
        }
      });
    }

    function handleCommand(command) {
      const cmd = command.trim().toLowerCase();
      addLogEntry(`> ${command}`, 'info');
      
      switch (cmd) {
        case 'help':
          showHelp();
          break;
        case 'test':
          createTestGraph();
          break;
        case 'init':
          loadExternalGraph();
          break;
        case 'theme':
          toggleTheme();
          break;
        case 'clear':
          clearConsole();
          break;
        case 'status':
          showStatus();
          break;
        case 'debug':
          showDebugInfo();
          break;
        case 'retry':
          retryGraphInitialization();
          break;
        default:
          addLogEntry(`Unknown command: "${command}". Type "help" for available commands.`, 'error');
      }
    }

    function showHelp() {
      addLogEntry('📖 Available Commands:', 'info');
      addLogEntry('  • help - Show available commands', 'info');
      addLogEntry('  • test - Create test graph with sample data', 'info');
      addLogEntry('  • init - Load graph data from React Native', 'info');
      addLogEntry('  • theme - Toggle between Matrix and Regular themes', 'info');
      addLogEntry('  • clear - Clear console log', 'info');
      addLogEntry('  • status - Show system status', 'info');
      addLogEntry('  • debug - Show debug information', 'info');
      addLogEntry('  • retry - Retry graph initialization', 'info');
    }

    function createTestGraph() {
      try {
        addLogEntry('🧪 Creating test graph...', 'info');
        showLoadingIndicator();
        
        // Check WebGL support
        if (!checkWebGLSupport()) {
          throw new Error('WebGL not supported or context lost');
        }
        
        // Simple test data
        const testData = {
          nodes: [
            { id: 'node1', name: 'Test Project', type: 'Project', val: 10 },
            { id: 'node2', name: 'Bug Fix Issue', type: 'Bug Fix', val: 8 },
            { id: 'node3', name: 'New Feature', type: 'Feature', val: 15 }
          ],
          links: [
            { source: 'node1', target: 'node2' },
            { source: 'node1', target: 'node3' }
          ]
        };

        const graphElement = document.getElementById('graph');
        graphElement.innerHTML = '';
        
        // Create graph with error handling
        const Graph = window.ForceGraph3D()(graphElement)
          .graphData(testData)
          .backgroundColor('#000000')
          .nodeColor(() => '#00FF41')
          .linkColor(() => '#004d1a')
          .nodeLabel('name')
          .onNodeClick(node => {
            addLogEntry(`🖱️ Node clicked: ${node.name}`, 'info');
          })
          .onEngineStop(() => {
            addLogEntry('🎯 Graph layout stabilized', 'success');
            hideLoadingIndicator();
          });

        // Store graph instance
        graphInstance = Graph;
        
        // Add WebGL context lost handler
        const canvas = graphElement.querySelector('canvas');
        if (canvas) {
          canvas.addEventListener('webglcontextlost', function(e) {
            e.preventDefault();
            addLogEntry('❌ WebGL context lost', 'error');
            showError('WebGL context lost. Tap retry to recover.');
          });
          
          canvas.addEventListener('webglcontextrestored', function(e) {
            addLogEntry('✅ WebGL context restored', 'success');
            hideError();
          });
        }

        addLogEntry('✅ Test graph created successfully', 'success');
        
      } catch (error) {
        hideLoadingIndicator();
        addLogEntry(`❌ Failed to create test graph: ${error.message}`, 'error');
        showError('Failed to create graph: ' + error.message);
      }
    }

    // WebGL support check
    function checkWebGLSupport() {
      try {
        const canvas = document.createElement('canvas');
        const context = canvas.getContext('webgl') || canvas.getContext('experimental-webgl');
        
        if (!context) {
          const errorMessage = 'WebGL not supported on this device';
          addLogEntry('❌ WebGL not supported', 'error');
          
          // Notify React Native of WebGL error
          if (window.ReactNativeWebView) {
            try {
              window.ReactNativeWebView.postMessage(JSON.stringify({
                type: 'webgl_error',
                error: errorMessage
              }));
            } catch (e) {
              console.error('Failed to send WebGL error to React Native:', e);
            }
          }
          
          return false;
        }
        
        // Check for context loss
        if (context.isContextLost && context.isContextLost()) {
          const errorMessage = 'WebGL context is lost';
          addLogEntry('❌ WebGL context is lost', 'error');
          
          // Notify React Native of WebGL context loss
          if (window.ReactNativeWebView) {
            try {
              window.ReactNativeWebView.postMessage(JSON.stringify({
                type: 'webgl_error',
                error: errorMessage
              }));
            } catch (e) {
              console.error('Failed to send WebGL error to React Native:', e);
            }
          }
          
          return false;
        }
        
        addLogEntry('✅ WebGL support confirmed', 'success');
        return true;
      } catch (e) {
        const errorMessage = `WebGL check failed: ${e.message}`;
        addLogEntry(`❌ ${errorMessage}`, 'error');
        
        // Notify React Native of WebGL error
        if (window.ReactNativeWebView) {
          try {
            window.ReactNativeWebView.postMessage(JSON.stringify({
              type: 'webgl_error',
              error: errorMessage
            }));
          } catch (e) {
            console.error('Failed to send WebGL error to React Native:', e);
          }
        }
        
        return false;
      }
    }

    function loadExternalGraph() {
      addLogEntry('📡 Requesting graph data from React Native...', 'info');
      
      if (window.ReactNativeWebView) {
        try {
          window.ReactNativeWebView.postMessage(JSON.stringify({
            type: 'request_graph_data'
          }));
          addLogEntry('✅ Request sent successfully', 'success');
        } catch (e) {
          addLogEntry(`❌ Failed to request graph data: ${e.message}`, 'error');
        }
      } else {
        addLogEntry('❌ Not running in React Native WebView', 'error');
      }
    }

    function toggleTheme() {
      const body = document.body;
      const isRegular = body.classList.contains('regular-theme');
      
      if (isRegular) {
        body.classList.remove('regular-theme');
        addLogEntry('🎨 Switched to Matrix theme', 'success');
      } else {
        body.classList.add('regular-theme');
        addLogEntry('🎨 Switched to Regular theme', 'success');
      }
    }

    function clearConsole() {
      const logDisplay = document.getElementById('log-display');
      if (logDisplay) {
        logDisplay.innerHTML = '';
        addLogEntry('Console cleared', 'success');
      }
    }

    function showStatus() {
      addLogEntry('📊 System Status:', 'info');
      addLogEntry(`  • Theme: ${document.body.classList.contains('regular-theme') ? 'Regular' : 'Matrix'}`, 'info');
      addLogEntry(`  • Graph Initialized: ${isGraphInitialized ? 'YES' : 'NO'}`, 'info');
      addLogEntry(`  • Retry Count: ${retryCount}/${MAX_RETRIES}`, 'info');
      addLogEntry(`  • WebGL Support: ${checkWebGLSupport() ? 'YES' : 'NO'}`, 'info');
      
      const libraryStatus = checkLibrariesWithDetails();
      addLogEntry(`  • Libraries: ${libraryStatus.allReady ? 'All Ready' : 'Missing: ' + libraryStatus.missing.join(', ')}`, libraryStatus.allReady ? 'success' : 'error');
    }

    function showDebugInfo() {
      addLogEntry('🔍 Debug Information:', 'info');
      addLogEntry(`  • User Agent: ${navigator.userAgent}`, 'info');
      addLogEntry(`  • Platform: ${navigator.platform}`, 'info');
      addLogEntry(`  • Screen: ${window.screen.width}x${window.screen.height}`, 'info');
      addLogEntry(`  • Viewport: ${window.innerWidth}x${window.innerHeight}`, 'info');
      addLogEntry(`  • Device Pixel Ratio: ${window.devicePixelRatio}`, 'info');
      addLogEntry(`  • WebGL Vendor: ${getWebGLInfo().vendor}`, 'info');
      addLogEntry(`  • WebGL Renderer: ${getWebGLInfo().renderer}`, 'info');
    }

    function getWebGLInfo() {
      try {
        const canvas = document.createElement('canvas');
        const gl = canvas.getContext('webgl') || canvas.getContext('experimental-webgl');
        
        if (!gl) return { vendor: 'N/A', renderer: 'N/A' };
        
        const debugInfo = gl.getExtension('WEBGL_debug_renderer_info');
        if (debugInfo) {
          return {
            vendor: gl.getParameter(debugInfo.UNMASKED_VENDOR_WEBGL),
            renderer: gl.getParameter(debugInfo.UNMASKED_RENDERER_WEBGL)
          };
        }
        
        return {
          vendor: gl.getParameter(gl.VENDOR),
          renderer: gl.getParameter(gl.RENDERER)
        };
      } catch (e) {
        return { vendor: 'Error', renderer: e.message };
      }
    }

    function addLogEntry(message, level = 'info') {
      const logDisplay = document.getElementById('log-display');
      if (!logDisplay) return;
      
      const timestamp = new Date().toLocaleTimeString();
      const logEntry = document.createElement('div');
      logEntry.className = `log-entry log-${level}`;
      
      logEntry.innerHTML = `
        <span class="log-timestamp">[${timestamp}]</span>
        <span class="log-message">${message}</span>
      `;
      
      logDisplay.appendChild(logEntry);
      logDisplay.scrollTop = logDisplay.scrollHeight;
      
      // Keep max 100 entries
      while (logDisplay.children.length > 100) {
        logDisplay.removeChild(logDisplay.firstChild);
      }
    }

    // Handle messages from React Native
    window.addEventListener('message', function(event) {
      try {
        const message = JSON.parse(event.data);
        console.log('Received message from React Native:', message);
        
        switch (message.type) {
          case 'updateTheme':
            const body = document.body;
            if (message.theme === 'regular') {
              body.classList.add('regular-theme');
            } else {
              body.classList.remove('regular-theme');
            }
            addLogEntry(`🎨 Theme updated to: ${message.theme}`, 'success');
            break;
            
          case 'loadGraphData':
            // Handle graph data loading with error handling
            addLogEntry('📊 Received graph data from React Native', 'success');
            try {
              loadGraphWithData(message.data);
            } catch (error) {
              addLogEntry(`❌ Failed to load graph data: ${error.message}`, 'error');
              showError('Failed to load graph data: ' + error.message);
            }
            break;
            
          case 'clearGraph':
            const graphElement = document.getElementById('graph');
            if (graphElement) {
              graphElement.innerHTML = '';
              addLogEntry('🔄 Graph cleared', 'info');
            }
            break;
        }
      } catch (error) {
        console.error('Failed to handle React Native message:', error);
        addLogEntry(`❌ Message handling error: ${error.message}`, 'error');
      }
    });

    // Load graph with actual data
    function loadGraphWithData(data) {
      if (!data || !data.entities || !data.relations) {
        throw new Error('Invalid graph data format');
      }
      
      showLoadingIndicator();
      addLogEntry('🔄 Loading graph with actual data...', 'info');
      
      // Check WebGL support first
      if (!checkWebGLSupport()) {
        throw new Error('WebGL not supported or context lost');
      }
      
      // Transform data for 3D Force Graph
      const transformedData = {
        nodes: data.entities.map(entity => ({
          id: entity.name,
          name: entity.name,
          type: entity.type,
          val: Math.min(entity.observations.length * 2 + 5, 20),
          observations: entity.observations
        })),
        links: data.relations.map(relation => ({
          source: relation.source,
          target: relation.target,
          relationType: relation.relationType
        }))
      };
      
      const graphElement = document.getElementById('graph');
      graphElement.innerHTML = '';
      
      // Create graph with comprehensive error handling
      const Graph = window.ForceGraph3D()(graphElement)
        .graphData(transformedData)
        .backgroundColor('#000000')
        .nodeColor(node => getNodeColor(node.type))
        .linkColor(() => '#004d1a')
        .nodeLabel(node => `${node.name} (${node.type})`)
        .onNodeClick(node => {
          addLogEntry(`🖱️ Node clicked: ${node.name} (${node.type})`, 'info');
          
          // Send node click to React Native
          if (window.ReactNativeWebView) {
            try {
              window.ReactNativeWebView.postMessage(JSON.stringify({
                type: 'nodeClicked',
                node: node,
                allData: data
              }));
            } catch (e) {
              addLogEntry(`❌ Failed to send node click: ${e.message}`, 'error');
            }
          }
        })
        .onEngineStop(() => {
          addLogEntry('🎯 Graph layout stabilized', 'success');
          hideLoadingIndicator();
        });

      // Store graph instance
      graphInstance = Graph;
      
      // Add WebGL context handlers
      const canvas = graphElement.querySelector('canvas');
      if (canvas) {
        canvas.addEventListener('webglcontextlost', function(e) {
          e.preventDefault();
          addLogEntry('❌ WebGL context lost during graph rendering', 'error');
          showError('WebGL context lost. Graph may need to be reloaded.');
        });
        
        canvas.addEventListener('webglcontextrestored', function(e) {
          addLogEntry('✅ WebGL context restored', 'success');
          hideError();
          // Attempt to reload graph
          setTimeout(() => {
            try {
              loadGraphWithData(data);
            } catch (error) {
              addLogEntry(`❌ Failed to reload graph after context restore: ${error.message}`, 'error');
            }
          }, 1000);
        });
      }
      
      addLogEntry(`✅ Graph loaded successfully with ${transformedData.nodes.length} nodes and ${transformedData.links.length} links`, 'success');
    }

    // Node color mapping
    function getNodeColor(nodeType) {
      const nodeColors = {
        'Project': '#00FF41',
        'Bug Fix': '#FF4444',
        'Feature': '#00DD35',
        'Component': '#00BB29',
        'Architecture': '#44FF44',
        'Infrastructure': '#00AA22',
        'Strategy': '#FFAA00',
        'Problem Analysis': '#FF6666',
        'Feature Implementation': '#00CC30',
        'Architecture Strategy': '#44CCFF',
        'default': '#00FF41'
      };
      
      return nodeColors[nodeType] || nodeColors.default;
    }

    console.log('🔧 Neron Graph Engine script loaded successfully');
  </script>
</body>
</html> 