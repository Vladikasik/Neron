<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>Neo4j Graph Visualization</title>
  
  <style>
    /* Base styling for the application */
    * {
      box-sizing: border-box;
    }

    body { 
      margin: 0; 
      padding: 0; 
      background: #000003;
      overflow: hidden;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      user-select: none;
    }

    #graph-container {
      position: relative;
      width: 100vw; 
      height: 100vh; 
    }

    #graph {
      width: 100%;
      height: 100%;
    }

    /* Console toggle button in bottom-left */
    #console-toggle {
      position: fixed;
      bottom: 20px;
      left: 20px;
      width: 50px;
      height: 50px;
      background: rgba(0, 0, 0, 0.8);
      border: 2px solid #00FF41;
      border-radius: 50%;
      color: #00FF41;
      font-family: 'Courier New', monospace;
      font-size: 20px;
      font-weight: bold;
      cursor: pointer;
      z-index: 1001;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s ease;
      backdrop-filter: blur(5px);
    }

    #console-toggle:hover {
      background: rgba(0, 255, 65, 0.1);
      box-shadow: 0 0 20px rgba(0, 255, 65, 0.5);
      transform: scale(1.1);
    }

    #console-toggle:active {
      transform: scale(0.95);
    }

    /* Draggable console window styling */
    .console-window {
      position: fixed;
      top: 50px;
      right: 50px;
      width: 400px;
      height: 350px;
      background: rgba(0, 0, 0, 0.95);
      border: 2px solid #00FF41;
      border-radius: 8px;
      box-shadow: 0 0 30px rgba(0, 255, 65, 0.3);
      backdrop-filter: blur(10px);
      z-index: 1000;
      display: flex;
      flex-direction: column;
      font-family: 'Courier New', monospace;
      transition: all 0.3s ease;
      resize: both;
      overflow: hidden;
      min-width: 300px;
      min-height: 200px;
      max-width: 80vw;
      max-height: 80vh;
    }

    .console-window.hidden {
      transform: scale(0.8);
      opacity: 0;
      pointer-events: none;
    }

    /* Removed minimized styles - no longer needed */

    .console-window.dragging {
      transition: none;
      box-shadow: 0 0 40px rgba(0, 255, 65, 0.5);
    }

    /* Console header */
    .console-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 15px;
      background: rgba(0, 255, 65, 0.1);
      border-bottom: 1px solid #00FF41;
      cursor: move;
      user-select: none;
      min-height: 40px;
    }

    .console-header:hover {
      background: rgba(0, 255, 65, 0.15);
    }

    .console-title {
      color: #00FF41;
      font-weight: bold;
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .console-controls {
      display: flex;
      gap: 5px;
    }

    .console-btn {
      width: 20px;
      height: 20px;
      background: rgba(0, 255, 65, 0.2);
      border: 1px solid #00FF41;
      border-radius: 3px;
      color: #00FF41;
      font-family: 'Courier New', monospace;
      font-size: 12px;
      font-weight: bold;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s ease;
    }

    .console-btn:hover {
      background: rgba(0, 255, 65, 0.3);
      transform: scale(1.1);
    }

    .console-btn:active {
      transform: scale(0.95);
    }

    /* Console content */
    .console-content {
      display: flex;
      flex-direction: column;
      flex: 1;
      overflow: hidden;
      padding: 10px;
    }

    .log-display {
      flex: 1;
      overflow-y: auto;
      font-size: 11px;
      line-height: 1.3;
      color: #00FF41;
      padding: 5px;
      background: rgba(0, 0, 0, 0.3);
      border: 1px solid rgba(0, 255, 65, 0.2);
      border-radius: 4px;
      margin-bottom: 10px;
    }

    .log-display::-webkit-scrollbar {
      width: 6px;
    }

    .log-display::-webkit-scrollbar-track {
      background: rgba(0, 255, 65, 0.1);
    }

    .log-display::-webkit-scrollbar-thumb {
      background: #00FF41;
      border-radius: 3px;
    }

    .log-entry {
      margin-bottom: 3px;
      opacity: 0.9;
      word-wrap: break-word;
      animation: fadeIn 0.3s ease;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 0.9; transform: translateY(0); }
    }

    .log-timestamp {
      color: #00BB29;
      font-size: 10px;
      margin-right: 5px;
    }

    .log-error {
      color: #FF6B6B;
    }

    .log-warning {
      color: #FFB347;
    }

    .log-success {
      color: #00DD35;
    }

    .log-info {
      color: #4ECDC4;
    }

    /* Input area */
    .input-area {
      display: flex;
      align-items: center;
      gap: 5px;
      padding: 8px;
      background: rgba(0, 0, 0, 0.3);
      border: 1px solid rgba(0, 255, 65, 0.2);
      border-radius: 4px;
    }

    .input-prompt {
      color: #00FF41;
      font-weight: bold;
      font-size: 12px;
      min-width: 15px;
    }

    .command-input {
      flex: 1;
      background: transparent;
      border: none;
      color: #00FF41;
      font-family: 'Courier New', monospace;
      font-size: 12px;
      outline: none;
      padding: 4px;
    }

    .command-input::placeholder {
      color: rgba(0, 255, 65, 0.4);
    }

    .command-input:focus {
      background: rgba(0, 255, 65, 0.05);
    }

    /* Regular theme */
    .regular-theme {
      background: #f8fafc;
      color: #1e293b;
    }

    .regular-theme body {
      background: #f8fafc;
    }

    .regular-theme #console-toggle {
      background: rgba(255, 255, 255, 0.9);
      border-color: #2563eb;
      color: #1e40af;
    }

    .regular-theme #console-toggle:hover {
      background: rgba(37, 99, 235, 0.1);
      box-shadow: 0 0 20px rgba(37, 99, 235, 0.5);
    }

    .regular-theme .console-window {
      background: rgba(255, 255, 255, 0.95);
      border-color: #2563eb;
      box-shadow: 0 0 30px rgba(37, 99, 235, 0.3);
      color: #1e40af;
    }

    .regular-theme .console-header {
      background: rgba(37, 99, 235, 0.1);
      border-bottom-color: #2563eb;
    }

    .regular-theme .console-title {
      color: #1e40af;
    }

    .regular-theme .console-btn {
      background: rgba(37, 99, 235, 0.2);
      border-color: #2563eb;
      color: #1e40af;
    }

    .regular-theme .console-btn:hover {
      background: rgba(37, 99, 235, 0.3);
    }

    .regular-theme .log-display {
      background: rgba(248, 250, 252, 0.5);
      border-color: rgba(37, 99, 235, 0.2);
      color: #374151;
    }

    .regular-theme .log-display::-webkit-scrollbar-track {
      background: rgba(37, 99, 235, 0.1);
    }

    .regular-theme .log-display::-webkit-scrollbar-thumb {
      background: #2563eb;
    }

    .regular-theme .log-timestamp {
      color: #6b7280;
    }

    .regular-theme .input-area {
      background: rgba(248, 250, 252, 0.5);
      border-color: rgba(37, 99, 235, 0.2);
    }

    .regular-theme .input-prompt {
      color: #1e40af;
    }

    .regular-theme .command-input {
      color: #1e40af;
    }

    .regular-theme .command-input::placeholder {
      color: rgba(30, 64, 175, 0.4);
    }

    .regular-theme .command-input:focus {
      background: rgba(37, 99, 235, 0.05);
    }

    /* Regular theme log levels */
    .regular-theme .log-error {
      color: #dc2626;
    }

    .regular-theme .log-warning {
      color: #d97706;
    }

    .regular-theme .log-success {
      color: #16a34a;
    }

    .regular-theme .log-info {
      color: #0284c7;
    }

    /* Loading animation */
    .loading {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      color: #00FF41;
      font-family: 'Courier New', monospace;
      font-size: 16px;
      z-index: 2000;
    }

    .loading::after {
      content: '';
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 2px solid #00FF41;
      border-radius: 50%;
      border-top-color: transparent;
      animation: spin 1s linear infinite;
      margin-left: 10px;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Scrollbar styling */
    ::-webkit-scrollbar {
      width: 6px;
    }

    ::-webkit-scrollbar-track {
      background: rgba(0, 255, 65, 0.1);
    }

    ::-webkit-scrollbar-thumb {
      background: #00FF41;
      border-radius: 3px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: #00DD35;
    }
  </style>

  <!-- External libraries - using only the required versions -->
  <script src="https://unpkg.com/three@0.157.0/build/three.min.js"></script>
  <script src="https://unpkg.com/3d-force-graph@1.77.0/dist/3d-force-graph.min.js"></script>
</head>
<body>
    <div id="graph-container">
    <div id="graph"></div>
  </div>
  
  <!-- Console toggle button (bottom-left) -->
  <button id="console-toggle" class="console-visible" title="Toggle Console">⚡</button>
  
  <!-- Draggable console window -->
  <div id="console-window" class="console-window">
    <div id="console-header" class="console-header">
      <span class="console-title">⚡ NERON CONSOLE v2.0</span>
      <div class="console-controls">
        <button id="console-close" class="console-btn">×</button>
      </div>
    </div>
    <div id="console-content" class="console-content">
      <div id="log-display" class="log-display"></div>
      <div id="input-area" class="input-area">
        <span id="input-prompt" class="input-prompt">></span>
        <input type="text" id="command-input" class="command-input" placeholder="Type 'help' for commands..." />
      </div>
    </div>
  </div>

  <script>
    // Initialize the application when DOM is ready
    document.addEventListener('DOMContentLoaded', function() {
      try {
        console.log('🔧 Initializing Neron Graph Engine v2.0...');
        console.log('🌐 Environment:', window.ReactNativeWebView ? 'React Native' : 'Web Browser');
        
        // Logger class - inline implementation
        class Logger {
          constructor() {
            this.levels = { ERROR: 0, WARN: 1, INFO: 2, DEBUG: 3 };
            this.currentLevel = this.levels.INFO;
            this.prefix = '[NeronEngine]';
            this.startTime = Date.now();
            this.sessionId = Math.random().toString(36).substring(2, 15);
            console.log(`${this.prefix} Logger initialized - Session: ${this.sessionId}`);
          }
          
          formatMessage(level, message, data = null) {
            const timestamp = new Date().toISOString();
            const uptime = Date.now() - this.startTime;
            const baseMessage = `${this.prefix} [${level}] [${timestamp}] [+${uptime}ms] ${message}`;
            return { baseMessage, data };
          }
          
          log(level, message, data = null) {
            if (this.levels[level] > this.currentLevel) return;
            
            const { baseMessage, data: logData } = this.formatMessage(level, message, data);
            
            switch (level) {
              case 'ERROR': console.error(baseMessage, logData || ''); break;
              case 'WARN': console.warn(baseMessage, logData || ''); break;
              case 'INFO': console.info(baseMessage, logData || ''); break;
              case 'DEBUG': console.debug(baseMessage, logData || ''); break;
              default: console.log(baseMessage, logData || '');
            }
            
            // Send to React Native if available
            if (window.ReactNativeWebView) {
              try {
                window.ReactNativeWebView.postMessage(JSON.stringify({
                  type: 'log', level: level.toLowerCase(), message: baseMessage, data: logData, sessionId: this.sessionId
                }));
              } catch (e) {
                console.error(`${this.prefix} Failed to send log to React Native:`, e);
              }
            }
          }
          
          error(message, data = null) { this.log('ERROR', message, data); }
          warn(message, data = null) { this.log('WARN', message, data); }
          info(message, data = null) { this.log('INFO', message, data); }
          debug(message, data = null) { this.log('DEBUG', message, data); }
          success(message, data = null) {
            const { baseMessage, data: logData } = this.formatMessage('SUCCESS', message, data);
            console.log(`%c${baseMessage}`, 'color: #00DD35', logData || '');
      if (window.ReactNativeWebView) {
        try {
          window.ReactNativeWebView.postMessage(JSON.stringify({
                  type: 'log', level: 'success', message: baseMessage, data: logData, sessionId: this.sessionId
          }));
        } catch (e) {
                console.error(`${this.prefix} Failed to send log to React Native:`, e);
              }
            }
          }
          
          setLevel(level) {
            if (this.levels[level] !== undefined) {
              this.currentLevel = this.levels[level];
              this.info(`Log level set to: ${level}`);
            } else {
              this.warn(`Invalid log level: ${level}`);
            }
          }
        }

        // Create global logger
        window.Logger = new Logger();

        // Simple NeronGraphEngine initialization
        window.Logger.info('🚀 Neron Graph Engine loading...');
        
        // Check libraries
        const threeAvailable = typeof window.THREE !== 'undefined';
        const forceGraphAvailable = typeof window.ForceGraph3D !== 'undefined';
        
        window.Logger.info(`Libraries check: THREE.js ${threeAvailable ? '✅' : '❌'}, ForceGraph3D ${forceGraphAvailable ? '✅' : '❌'}`);
        
        if (!threeAvailable || !forceGraphAvailable) {
          throw new Error('Required libraries not available');
        }

        // Initialize console functionality
        initializeConsole();
        
        // Ensure console is visible
        showConsole();
        
        window.Logger.success('✅ Neron Graph Engine initialized successfully');
        
        // Add welcome message to console with timestamp to verify updates
        const buildTime = new Date().toISOString();
        addLogEntry('🚀 Neron Graph Engine v2.0 initialized', 'success');
        addLogEntry('💻 Console: Drag header to move, × to hide', 'info');
        addLogEntry(`🕒 Build: ${buildTime}`, 'info');
        addLogEntry('Type "help" for available commands', 'info');
      } catch (error) {
        console.error('❌ Failed to initialize Neron Graph Engine:', error);
        alert('Failed to initialize application. Check console for details.');
      }
    });

    // Console functionality
    let isConsoleVisible = true;

    function initializeConsole() {
      // Console toggle functionality
      const toggleButton = document.getElementById('console-toggle');
      const consoleWindow = document.getElementById('console-window');
      
      if (toggleButton) {
        toggleButton.addEventListener('click', function(e) {
          e.stopPropagation();
          toggleConsole();
        });
      }

      // Console controls
      const closeBtn = document.getElementById('console-close');
      
      if (closeBtn) {
        closeBtn.addEventListener('click', function(e) {
          e.stopPropagation();
          hideConsole();
        });
      }

      // Setup drag functionality
      setupDragFunctionality();
      
      // Setup command input
      setupCommandInput();
      
      window.Logger.info('Console initialized successfully');
    }

    function toggleConsole() {
      if (isConsoleVisible) {
        hideConsole();
      } else {
        showConsole();
      }
    }

    function showConsole() {
      const consoleWindow = document.getElementById('console-window');
      const toggleButton = document.getElementById('console-toggle');
      
      isConsoleVisible = true;
      consoleWindow.classList.remove('hidden');
      toggleButton.innerHTML = '⚡';
      toggleButton.title = 'Hide Console';
      
      // Focus on input
      setTimeout(() => {
        const commandInput = document.getElementById('command-input');
        if (commandInput) commandInput.focus();
      }, 100);
    }

    function hideConsole() {
      const consoleWindow = document.getElementById('console-window');
      const toggleButton = document.getElementById('console-toggle');
      
      isConsoleVisible = false;
      consoleWindow.classList.add('hidden');
      toggleButton.innerHTML = '👁️';
      toggleButton.title = 'Show Console';
    }

    // Minimize functionality removed - only hide/show console

    function setupDragFunctionality() {
      const consoleWindow = document.getElementById('console-window');
      const consoleHeader = document.getElementById('console-header');
      let isDragging = false;

      consoleHeader.addEventListener('mousedown', function(e) {
        if (e.target.classList.contains('console-btn')) return;
        
        isDragging = true;
        consoleWindow.classList.add('dragging');
        
        const startX = e.clientX;
        const startY = e.clientY;
        const rect = consoleWindow.getBoundingClientRect();
        const startLeft = rect.left;
        const startTop = rect.top;

        function handleMouseMove(e) {
          if (!isDragging) return;
          
          const deltaX = e.clientX - startX;
          const deltaY = e.clientY - startY;
          let newLeft = startLeft + deltaX;
          let newTop = startTop + deltaY;
          
          // Boundary constraints
          const windowWidth = window.innerWidth;
          const windowHeight = window.innerHeight;
          const consoleWidth = consoleWindow.offsetWidth;
          const consoleHeight = consoleWindow.offsetHeight;
          
          newLeft = Math.max(0, Math.min(windowWidth - consoleWidth, newLeft));
          newTop = Math.max(0, Math.min(windowHeight - consoleHeight, newTop));
          
          consoleWindow.style.left = `${newLeft}px`;
          consoleWindow.style.top = `${newTop}px`;
          consoleWindow.style.right = 'auto';
          consoleWindow.style.bottom = 'auto';
        }

        function handleMouseUp() {
          isDragging = false;
          consoleWindow.classList.remove('dragging');
          document.removeEventListener('mousemove', handleMouseMove);
          document.removeEventListener('mouseup', handleMouseUp);
        }

        document.addEventListener('mousemove', handleMouseMove);
        document.addEventListener('mouseup', handleMouseUp);
        e.preventDefault();
      });
    }

    function setupCommandInput() {
      const commandInput = document.getElementById('command-input');
      if (!commandInput) return;

      commandInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
          e.preventDefault();
          const command = this.value;
          if (command.trim()) {
            handleCommand(command);
            this.value = '';
          }
        }
      });
    }

    function handleCommand(command) {
      const cmd = command.trim().toLowerCase();
      addLogEntry(`> ${command}`, 'info');
      
      switch (cmd) {
        case 'help':
          showHelp();
          break;
        case 'test':
          createTestGraph();
          break;
        case 'init':
        loadExternalGraph();
          break;
        case 'theme':
          toggleTheme();
          break;
        case 'clear':
          clearConsole();
          break;
        case 'status':
          showStatus();
          break;
        default:
          addLogEntry(`Unknown command: "${command}". Type "help" for available commands.`, 'error');
      }
    }

    function showHelp() {
      addLogEntry('📖 Available Commands:', 'info');
      addLogEntry('  • help - Show available commands', 'info');
      addLogEntry('  • test - Create test graph with sample data', 'info');
      addLogEntry('  • init - Load graph data from React Native', 'info');
      addLogEntry('  • theme - Toggle between Matrix and Regular themes', 'info');
      addLogEntry('  • clear - Clear console log', 'info');
      addLogEntry('  • status - Show system status', 'info');
    }

    function createTestGraph() {
      try {
        addLogEntry('🧪 Creating test graph...', 'info');
        
        // Simple test data
        const testData = {
          nodes: [
            { id: 'node1', name: 'Test Project', type: 'Project', val: 10 },
            { id: 'node2', name: 'Bug Fix Issue', type: 'Bug Fix', val: 8 },
            { id: 'node3', name: 'New Feature', type: 'Feature', val: 15 }
          ],
          links: [
            { source: 'node1', target: 'node2' },
            { source: 'node1', target: 'node3' }
          ]
        };

        const graphElement = document.getElementById('graph');
        graphElement.innerHTML = '';
        
        const Graph = window.ForceGraph3D()(graphElement)
          .graphData(testData)
          .backgroundColor('#000000')
          .nodeColor(() => '#00FF41')
          .linkColor(() => '#004d1a')
          .nodeLabel('name')
          .onNodeClick(node => {
            addLogEntry(`🖱️ Node clicked: ${node.name}`, 'info');
          });

        addLogEntry('✅ Test graph created successfully', 'success');
        
      } catch (error) {
        addLogEntry(`❌ Failed to create test graph: ${error.message}`, 'error');
      }
    }

    function loadExternalGraph() {
      addLogEntry('📡 Requesting graph data from React Native...', 'info');
      
      if (window.ReactNativeWebView) {
        try {
          window.ReactNativeWebView.postMessage(JSON.stringify({
            type: 'request_graph_data'
          }));
          addLogEntry('✅ Request sent successfully', 'success');
        } catch (e) {
          addLogEntry(`❌ Failed to request graph data: ${e.message}`, 'error');
        }
      } else {
        addLogEntry('❌ Not running in React Native WebView', 'error');
      }
    }

    function toggleTheme() {
      const body = document.body;
      const isRegular = body.classList.contains('regular-theme');
      
      if (isRegular) {
        body.classList.remove('regular-theme');
        addLogEntry('🎨 Switched to Matrix theme', 'success');
      } else {
        body.classList.add('regular-theme');
        addLogEntry('🎨 Switched to Regular theme', 'success');
      }
    }

    function clearConsole() {
      const logDisplay = document.getElementById('log-display');
      if (logDisplay) {
        logDisplay.innerHTML = '';
        addLogEntry('Console cleared', 'success');
      }
    }

    function showStatus() {
      addLogEntry('📊 System Status:', 'info');
      addLogEntry(`  • Theme: ${document.body.classList.contains('regular-theme') ? 'Regular' : 'Matrix'}`, 'info');
      addLogEntry(`  • Libraries: THREE.js ${typeof window.THREE !== 'undefined' ? '✅' : '❌'}, ForceGraph3D ${typeof window.ForceGraph3D !== 'undefined' ? '✅' : '❌'}`, 'info');
    }

    function addLogEntry(message, level = 'info') {
      const logDisplay = document.getElementById('log-display');
      if (!logDisplay) return;
      
      const timestamp = new Date().toLocaleTimeString();
      const logEntry = document.createElement('div');
      logEntry.className = `log-entry log-${level}`;
      
      logEntry.innerHTML = `
        <span class="log-timestamp">[${timestamp}]</span>
        <span class="log-message">${message}</span>
      `;
      
      logDisplay.appendChild(logEntry);
      logDisplay.scrollTop = logDisplay.scrollHeight;
      
      // Keep max 100 entries
      while (logDisplay.children.length > 100) {
        logDisplay.removeChild(logDisplay.firstChild);
      }
    }

    // Handle messages from React Native
    window.addEventListener('message', function(event) {
      try {
        const message = JSON.parse(event.data);
        console.log('Received message from React Native:', message);
        
        switch (message.type) {
          case 'updateTheme':
            const body = document.body;
            if (message.theme === 'regular') {
              body.classList.add('regular-theme');
            } else {
              body.classList.remove('regular-theme');
            }
            addLogEntry(`🎨 Theme updated to: ${message.theme}`, 'success');
            break;
            
          case 'loadGraphData':
            // Handle graph data loading
            addLogEntry('📊 Received graph data from React Native', 'success');
            break;
            
          case 'clearGraph':
            const graphElement = document.getElementById('graph');
            if (graphElement) {
              graphElement.innerHTML = '';
              addLogEntry('🔄 Graph cleared', 'info');
            }
            break;
        }
      } catch (error) {
        console.error('Failed to handle React Native message:', error);
      }
    });

    console.log('🔧 Neron Graph Engine script loaded successfully');
  </script>
</body>
</html> 